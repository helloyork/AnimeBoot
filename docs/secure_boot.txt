Secure Boot 签名与部署策略

0) 术语与工具
   - OpenSSL (生成 PK/KEK/DB 证书)。
   - efitools（cert-to-efi-sig-list、sign-efi-sig-list、KeyTool.efi）。
   - sbsigntool / sbverify（Linux 环境下对 EFI 可执行文件签名与验证）。
   - Windows SDK signtool.exe（Authenticode 签名，本仓库提供 scripts\Sign-AnimeBoot.ps1 作包装）。
   - 官方 shim（若走 shim 路线，需要编译时加入个人厂商证书）。

1) 路线 A：自建 PK/KEK/DB（推荐用于实验环境或自持硬件）
   1.1 生成证书（示例使用 10 年有效期，按需调整）:
       openssl req -new -x509 -sha256 -days 3650 -nodes -out pk.crt  -keyout pk.key  -subj "/CN=AnimeBoot Platform Key/"
       openssl req -new -x509 -sha256 -days 3650 -nodes -out kek.crt -keyout kek.key -subj "/CN=AnimeBoot KEK/"
       openssl req -new -x509 -sha256 -days 3650 -nodes -out db.crt  -keyout db.key  -subj "/CN=AnimeBoot DB/"
   1.2 将证书转换为 EFI 变量:
       cert-to-efi-sig-list pk.crt  pk.esl
       cert-to-efi-sig-list kek.crt kek.esl
       cert-to-efi-sig-list db.crt  db.esl
       sign-efi-sig-list -k pk.key  -c pk.crt  PK  pk.esl  pk.auth
       sign-efi-sig-list -k pk.key  -c pk.crt  KEK kek.esl kek.auth
       sign-efi-sig-list -k kek.key -c kek.crt db  db.esl  db.auth
   1.3 进入固件设置，关闭 Secure Boot，使用 KeyTool.efi 或厂商提供的密钥管理界面依次写入 pk.auth、kek.auth、db.auth。写入完成后重新开启 Secure Boot。
   1.4 使用 db.key/db.crt 对 AnimeBoot.efi 签名：
       sbsign --key db.key --cert db.crt --output AnimeBoot.signed.efi AnimeBoot.efi
       或者在 Windows 上运行:
       scripts\Sign-AnimeBoot.ps1 -InputEfi Build\...\AnimeBoot.efi -PfxPath animeboot-db.pfx -PfxPassword ****** -OutputEfi Build\...\AnimeBoot.signed.efi
   1.5 使用 sbverify --list AnimeBoot.signed.efi 确认签名链正确后，将该文件重命名为 AnimeBoot.efi 并部署到 ESP。
   1.6 若需要对 host-tools 输出的其它 EFI 应用（例如 KeyTool.efi fork）签名，同样使用 db.key/db.crt 处理，确保所有链中的二进制均被信任。

2) 路线 B：shim + Microsoft UEFI CA（适合在保留 OEM PK/KEK 的机器上测试）
   2.1 从 shim 官方仓库获取源码或使用已通过 Microsoft UEFI CA 签名的 shim 版本。编译 shim 时需把自己的 vendor cert 植入（使用 VENDOR_CERT 或 MokManager 流程）。
   2.2 使用 vendor cert 的私钥对 AnimeBoot.efi 签名（同样可用 sbsign 或 Sign-AnimeBoot.ps1）。
   2.3 将 shimx64.efi 放置在 ESP（例如 \EFI\AnimeBoot\shimx64.efi），并在 firmware 中注册该 shim 为首个启动项。Shim 配置的 fallback/grub.cfg 中加载 AnimeBoot.efi。
   2.4 首次启动时，若采用 MokManager 流程，需要在 shim 的界面中手动确认并导入 vendor cert。
   2.5 之后由 shim 验证 AnimeBoot.efi 的签名，验证通过后再由 AnimeBoot.efi 链接 bootmgfw.efi，从而在启用 Secure Boot 的 OEM 环境下保持动画流程。

3) 运行时安全限制
   - AnimeBootPkg 在加载 .anim 文件前会校验魔数、版本、帧计数、单帧大小、总偏移，确保文件长度不超 16MB/帧及 2GB 容器上限。
   - Manifest 中的 loop_count、max_memory、max_total_duration_ms 会被强制截断在可控范围内，防止恶意内容拖延启动。
   - 任何 I/O 或像素解码错误都会立即放弃动画并直接返回下一阶段（bootmgfw.efi），因此签名错误或资源损坏不会阻断系统启动。

4) 证书保护建议
   - 在生产环境中，将 PK/KEK/DB 私钥保存在 HSM 或硬件令牌（如 YubiKey PIV）中，签名时通过 PKCS#11 接口调用，避免私钥落地。
   - 对测试环境，建议使用不同的证书层级（Test PK -> Test DB），以免影响正式 Secure Boot 链。
   - 定期使用 sbverify 或 signtool verify /pa /kp /v AnimeBoot.efi 检查签名状态，防止证书过期导致的启动失败。

5) 与部署脚本的结合
   - 在构建流水线中先运行 Sign-AnimeBoot.ps1（或 sbsign），再调用 scripts\Install-AnimeBoot.ps1，确保复制到 ESP 的始终是签名版本。
   - 通过 CI 在 QEMU + OVMF Secure Boot 模式下运行 sbverify + qemu-system-x86_64 -bios OVMF_CODE.secboot.fd 测试，以自动验证签名链完整性。

